<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ü™ê ARMAJ Trip Picker ‚Äî Thailand</title>
<meta name="description" content="Two Thailand itineraries: Jungle+Gulf Party (Cheow Lan + Koh Phangan) and North Loop (Chiang Mai + Pai). Vote with your crew." />

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2284%22>ü™ê</text></svg>">

<style>
  :root{
    --fg:#eaf0ff; --muted:#b7c6e9; --line:#1a2342;
    --glass:#0a0f21cc; --glass2:#0a0e1ccc; --hot:#ffd166;
    --btn:#0c1333; --btnb:#2a3569; --accent:#19d1a3;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; color:var(--fg); font-family: ui-sans-serif,system-ui,-apple-system,"SF Pro Text","Segoe UI",Roboto,Arial; background:#070a16; overflow-x:hidden}

  .nebula{ position:fixed; inset:-25vmax; z-index:-3; filter:blur(80px) saturate(120%);
    background:
      radial-gradient(60vmax 40vmax at 10% 10%, #18223d 0%, transparent 60%),
      radial-gradient(70vmax 50vmax at 85% 15%, #151f3a 0%, transparent 60%),
      radial-gradient(90vmax 60vmax at 40% 90%, #1a2448 0%, transparent 70%);
    opacity:.85; animation: driftNeb 40s ease-in-out infinite alternate;
  }
  @keyframes driftNeb { from{transform:translate3d(0,0,0)} to{transform:translate3d(2vmin,-2vmin,0)} }
  canvas#stars{ position:fixed; inset:0; z-index:-2; display:block }

  header{position:sticky; top:0; z-index:20; background:var(--glass2); border-bottom:1px solid var(--line); backdrop-filter:blur(10px) saturate(160%)}
  .wrap{max-width:1100px; margin:0 auto; padding:12px 14px}
  .toprow{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .brand{display:flex; align-items:center; gap:10px}
  .brand h1{font-size:18px; margin:0; font-weight:900; letter-spacing:.2px}
  .brand .emoji{font-size:22px}
  .bar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px}
  .btn{background:var(--btn); color:#eaf6ff; border:1px solid #2a3569; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800}
  .btn.hot{background:linear-gradient(90deg,#19d1a3,#87a9ff); color:#041515; border-color:#47e2d4}
  .btn.ghost{background:transparent}
  .hint{color:#9fb3eb; font-size:12px}

  .sectionTitle{max-width:1100px; margin:8px auto 0; padding:0 14px; opacity:.95}
  .sectionTitle h2{margin:18px 0 8px; font-size:22px; letter-spacing:.3px}
  .sectionTitle p{margin:0 0 6px; color:#c9d7ff; font-size:14px}

  main .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(310px,1fr)); padding:12px 14px 120px; max-width:1100px; margin:0 auto}

  .card{
    background: linear-gradient(180deg, rgba(11,17,38,.35), rgba(10,15,32,.28));
    border: 1px solid rgba(32,40,77,.45);
    border-radius: 18px; padding:14px; position:relative; overflow:hidden;
    box-shadow: 0 16px 36px -22px #000, 0 0 0 1px rgba(15,26,54,.35) inset;
    backdrop-filter: blur(8px) saturate(120%);
  }
  .badge{position:absolute; top:10px; right:10px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a376a; background:#0d1633b0; color:#b8c7ff}
  .titleRow{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .title{font-weight:900; font-size:18px; margin:2px 0 6px}
  .meta{color:#cfe0ff; font-size:12px; display:flex; gap:8px; flex-wrap:wrap; margin:4px 0 8px}
  .tag{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2b3767; background:#0e1633aa}
  .why{color:#e7efff; font-size:14px; margin:6px 0 12px; line-height:1.45}

  .carousel{position:relative; border-radius:14px; overflow:hidden; border:1px solid rgba(60,78,140,.4); background:#0a0f20}
  .track{display:flex; scroll-snap-type:x mandatory; overflow:auto; gap:0; scroll-behavior:smooth}
  .track::-webkit-scrollbar{display:none}
  .slide{min-width:100%; height:200px; background:#0b1126; display:flex; align-items:center; justify-content:center; scroll-snap-align:center}
  .slide img{width:100%; height:100%; object-fit:cover; display:block; filter:contrast(1.08) saturate(1.06)}
  .ctrl{position:absolute; top:50%; transform:translateY(-50%); background:#0b1238cc; border:1px solid #3b4c88; color:#e8f1ff; width:34px; height:34px; border-radius:50%; display:grid; place-items:center; cursor:pointer}
  .ctrl:hover{background:#0d1644}
  .prev{left:8px} .next{right:8px}
  .dots{position:absolute; bottom:8px; left:0; right:0; display:flex; gap:6px; justify-content:center}
  .dot{width:7px; height:7px; border-radius:50%; background:#5b6aa5; opacity:.6}
  .dot.active{background:var(--accent); opacity:1}

  .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px}
  .count{font-weight:900; color:var(--hot)}
  .liked{background:linear-gradient(90deg,#1cc9a3,#80f)!important; color:#021611!important; border-color:#44e4d8!important}

  .sheet{position:fixed; left:0; right:0; bottom:-60vh; height:60vh; background:var(--glass); border-top:1px solid var(--line); backdrop-filter:blur(10px) saturate(160%); border-top-left-radius:14px; border-top-right-radius:14px; z-index:24; transition:bottom .25s ease}
  .sheet.open{bottom:0}
  .sheet .drag{width:44px; height:5px; background:#30406f; border-radius:999px; margin:8px auto}
  .sheet .inside{max-width:1100px; margin:0 auto; padding:8px 14px 20px}
  .lead-row{display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #213056}
  .lead-name{font-weight:800} .lead-score{font-weight:900; color:var(--hot)}

  .compare{position:fixed; inset:0; background:#000a; display:none; z-index:28}
  .compare.open{display:block}
  .compare .panel{
    position:absolute; left:0; right:0; bottom:0; max-height:85vh; background:var(--glass);
    border-top:1px solid var(--line); backdrop-filter: blur(10px) saturate(160%); border-top-left-radius:16px; border-top-right-radius:16px;
    padding:10px 14px 18px;
  }
  .compare h3{margin:6px 0 10px}
  .compareGrid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .cmpCard{background:linear-gradient(180deg, rgba(13,18,42,.55), rgba(10,15,32,.45)); border:1px solid rgba(60,78,140,.45); border-radius:14px; overflow:hidden}
  .cmpImg{height:140px; background:#0b1126}
  .cmpImg img{width:100%; height:100%; object-fit:cover}
  .cmpBody{padding:10px}
  .cmpBody h4{margin:0 0 6px}
  .cmpBody p{margin:6px 0; color:#dfe9ff}
  .cmpBody .mini{font-size:12px; color:#b8c6e9}
  .cmpClose{ position:absolute; right:12px; top:10px; border-radius:999px; padding:8px 12px; background:#101a3a; border:1px solid #3b4c88; color:#eaf2ff; cursor:pointer }

  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:30}
  .modal.open{display:flex}
  .modal .veil{position:absolute; inset:0; background:#000a; backdrop-filter: blur(2px)}
  .modal .cardM{
    position:relative; z-index:1; width:min(740px, calc(100% - 24px));
    background: linear-gradient(180deg, rgba(11,17,38,.6), rgba(10,15,32,.5));
    border:1px solid rgba(60,78,140,.5); border-radius:16px; padding:16px;
    box-shadow:0 20px 60px -30px #000;
    backdrop-filter: blur(10px) saturate(140%);
  }
  .modal h3{margin:0 0 6px; font-size:20px}
  .modal p{margin:6px 0 10px; color:#d9e6ff}
  .modal .facts{display:grid; gap:8px}
  .modal .facts .row{display:flex; gap:8px; align-items:flex-start}
  .modal .facts .row .b{min-width:120px; color:#bcd0ff}
  .closeX{position:absolute; top:8px; right:8px; background:#111b3a; border:1px solid #3b4c88; color:#dfe9ff; border-radius:10px; padding:6px 10px; cursor:pointer}

  footer{position:sticky; bottom:0; background:var(--glass2); border-top:1px solid var(--line); z-index:20}
  footer .wrap{display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap}

  @media (max-width:640px){
    .brand h1{font-size:16px}
    .btn{padding:12px 14px}
    .title{font-size:19px}
    .why{font-size:15px}
  }
</style>
</head>
<body>
<div class="nebula" aria-hidden="true"></div>
<canvas id="stars" aria-hidden="true"></canvas>

<header>
  <div class="wrap">
    <div class="toprow">
      <div class="brand"><span class="emoji">ü™ê</span><h1>ARMAJ Trip Picker ‚Äî Thailand</h1></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="share" class="btn hot">üîó Share My Votes</button>
        <button id="shareGroup" class="btn">üåê Share Group Totals</button>
      </div>
    </div>
    <div class="bar">
      <span class="hint">Two options. Tap üëç to vote, tap again to un-vote. Import friends‚Äô links to see group totals.</span>
      <button id="importBtn" class="btn">‚¨áÔ∏è Import Votes</button>
    </div>
  </div>
</header>

<div class="sectionTitle"><h2>Pick one</h2><p>We curated two paths. Both minimize transit; both are fun. Vote your vibe.</p></div>
<main>
  <div class="grid" id="itinGrid"></div>
</main>

<div class="fab" style="position:fixed; right:14px; bottom:84px; z-index:25"><button id="toggleSheet" class="btn hot">üèÜ Leaderboard</button></div>
<div class="compareFab" style="position:fixed; left:14px; bottom:84px; z-index:25"><button id="toggleCompare" class="btn">üß™ Compare Finalists</button></div>

<!-- Bottom Sheet Leaderboard -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="drag"></div>
  <div class="inside">
    <h3 style="margin:4px 0 6px">Group Leaderboard</h3>
    <div id="leaderboard"></div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
      <button id="sortVotes" class="btn">Sort by Votes</button>
      <button id="resetVotes" class="btn">üóëÔ∏è Reset My Device</button>
      <button id="resetGroup" class="btn">üóëÔ∏è Reset Imported</button>
    </div>
  </div>
</div>

<!-- Facts / Itinerary Modal -->
<div id="factsModal" class="modal" aria-hidden="true">
  <div class="veil"></div>
  <div class="cardM">
    <button class="closeX" id="factsClose">‚úï</button>
    <h3 id="factsTitle">Itinerary</h3>
    <p id="factsSub" class="mini"></p>
    <div class="facts" id="factsBody"></div>
  </div>
</div>

<!-- Compare Drawer -->
<div id="compare" class="compare" aria-hidden="true">
  <div class="panel">
    <button class="cmpClose" id="cmpClose">Close ‚úï</button>
    <h3>Compare the two</h3>
    <div id="cmpGrid" class="compareGrid"></div>
  </div>
</div>

<footer>
  <div class="wrap">
    <div class="hint">Long-press üëç to reset that card. Share links with friends to merge votes.</div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <span id="groupCount" class="hint"></span>
      <span id="roomPill" class="hint" style="display:inline">¬∑ Room: <b>armaj-th</b> ¬∑ local-only</span>
    </div>
  </div>
</footer>

<script>
/* ---------- Minimal stars backdrop ---------- */
const C=document.getElementById('stars'),X=C.getContext('2d'); function fit(){C.width=innerWidth; C.height=innerHeight} addEventListener('resize',fit); fit();
const S=Array.from({length:240},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,z:0.6+Math.random()*0.8,t:Math.random()*6}));
(function loop(t){ X.clearRect(0,0,C.width,C.height);
  S.forEach(s=>{ s.y=(s.y+0.03*s.z)%innerHeight; const a=0.6+0.4*Math.sin(t*0.001+s.t); X.globalAlpha=a; X.fillStyle='#fff';
    X.fillRect(s.x,s.y,1.2*s.z,1.2*s.z); }); requestAnimationFrame(loop);
})(0);

/* ---------- Data: TWO itineraries ---------- */
const srcUnsplash = q => `https://source.unsplash.com/1200x800/?${encodeURIComponent(q)}`;

const ITINS = [
  {
    id:'itin-cheowlan-phangan',
    cat:'Thailand',
    name:'Cheow Lan Lake + Koh Phangan (Party Wed)',
    why:'Float on an emerald lake with wildlife safaris, then island party + recovery. Minimal travel, max vibe.',
    imgs:[
      srcUnsplash('cheow lan lake thailand'),
      srcUnsplash('khao sok national park longtail'),
      srcUnsplash('koh phangan beach sunset')
    ],
    tags:['jungle','boat-safari','floating-bungalows','party','recovery'],
    facts:{
      bestTime:'Dec‚ÄìApr (drier on the Andaman/Jungle side; Gulf improves through Dec).',
      stays:'Floating raft house on Cheow Lan ‚Üí beachfront bungalow on Phangan.',
      vibe:'Dawn mist, hornbills & gibbons, then turquoise bays & music.',
      map:'https://maps.google.com/?q=Ratchaprapha+Pier'
    },
    days:[
      ['Sun 14 (optional)','Bangkok soft-land: Grand Palace & Wat Pho ‚Üí canal ride ‚Üí Chinatown; optional techno warm-up (BEAM/Mustache).'],
      ['Mon 15','Fly BKK‚ÜíSurat Thani (URT). Van to Ratchaprapha Pier ‚Üí long-tail to **floating bungalows**. Lunch, swim/kayak, **Pakarang/Coral Cave** (conditions), **sunset wildlife boat safari**, stargaze.'],
      ['Tue 16','**Sunrise mist safari** (prime wildlife window). Boat back ‚Üí van to Donsak ‚Üí ferry to **Koh Phangan**. Easy sunset swim.'],
      ['Wed 17','Light day: beach, Brunch, short **Than Sadet** waterfall hop. **Party at night** (goes into Thu).'],
      ['Thu 18','Recovery on quiet north bays (**Haad Salad/Secret Beach**).'],
      ['Fri 19 / Sat 20','Exit: Phangan‚ÜíSamui ferry ‚Üí fly USM‚ÜíBKK. If leaving 20th, keep Fri as extra beach/chill.']
    ]
  },
  {
    id:'itin-chiangmai-pai',
    cat:'Thailand',
    name:'North Loop: Bangkok ‚Üí Chiang Mai ‚Üí Pai',
    why:'Mountains, hot springs, canyons & waterfalls, ethical elephants, live music ‚Äî low transit, high soul.',
    imgs:[
      srcUnsplash('chiang mai doi suthep sunrise'),
      srcUnsplash('pai canyon thailand'),
      srcUnsplash('thailand hot springs forest')
    ],
    tags:['mountains','hot-springs','waterfalls','boho','ethical-wildlife'],
    facts:{
      bestTime:'Nov‚ÄìFeb (cooler, clearer in the north).',
      stays:'Old City/Nimman in Chiang Mai, riverside bungalow in Pai.',
      vibe:'Scooters, lantern nights, coffee culture, yoga/breathwork.',
      map:'https://maps.google.com/?q=Chiang+Mai'
    },
    days:[
      ['Sun 14 (optional)','Bangkok warm-up: canal ride + Chinatown or a rooftop; sleep early.'],
      ['Mon 15','Fly BKK‚ÜíCNX (Chiang Mai). Old City temple walk; sunset at **Doi Suthep** outlook; Nimman caf√©s.'],
      ['Tue 16','Minivan **Chiang Mai‚ÜíPai** (3‚Äì3.5h). Check-in, **Pai Canyon** sunset, **Tha Pai Hot Springs** soak.'],
      ['Wed 17','Scooter loop: **Mo Paeng/Pam Bok** waterfalls, Bamboo Bridge, caf√©s. (If you must party Wed, better to do Bangkok another time ‚Äî this loop is mellow.)'],
      ['Thu 18','Back to Chiang Mai. Afternoon **ethical elephant** visit (observation-only) or relax.'],
      ['Fri 19 / Sat 20','**Doi Inthanon** day trip (highest peak, waterfalls, short forest trails) OR Sticky Waterfall. Fly CNX‚ÜíBKK to depart.']
    ]
  }
];

/* ---------- State & helpers ---------- */
const $ = s => document.querySelector(s);
const votesKey = 'votes_device_th_v1';
const groupKey = 'votes_group_th_v1';
let myVotes = loadJson(votesKey) || {};
let groupMembers = loadJson(groupKey) || [];
function loadJson(k){ try{return JSON.parse(localStorage.getItem(k)||'null')}catch(e){return null} }
function saveJson(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ---------- Render cards ---------- */
function render(){
  const grid = $('#itinGrid'); grid.innerHTML='';
  ITINS.forEach(d=>{
    const mine = !!myVotes[d.id];
    const total = groupTotalFor(d.id);
    const el = document.createElement('div'); el.className='card';

    const slides = d.imgs.map((src,i)=>`<div class="slide"><img src="${src}" alt="${d.name} photo ${i+1}"></div>`).join('');
    const dots = d.imgs.map((_,i)=>`<span class="dot ${i===0?'active':''}" data-dot="${d.id}" data-idx="${i}"></span>`).join('');

    el.innerHTML = `
      <div class="badge">${d.cat}${total===topScore()&&total>0?' ¬∑ <span>üëë Top</span>':''}</div>
      <div class="titleRow">
        <div class="title">${d.name}</div>
        <div>
          <button class="btn ghost" data-facts="${d.id}" title="Itinerary & map">üìå Itinerary</button>
        </div>
      </div>

      <div class="carousel" data-id="${d.id}">
        <div class="track" id="trk_${d.id}">
          ${slides}
        </div>
        <button class="ctrl prev" data-prev="${d.id}">‚Äπ</button>
        <button class="ctrl next" data-next="${d.id}">‚Ä∫</button>
        <div class="dots" id="dots_${d.id}">${dots}</div>
      </div>

      <div class="meta" style="margin-top:10px">${d.tags.map(t=>`<span class="tag">#${t}</span>`).join(' ')}</div>
      <p class="why"><b>Why:</b> ${d.why}</p>

      <div class="actions">
        <button class="btn ${mine?'liked':''}" data-vote="${d.id}" aria-pressed="${mine}">${mine?'‚úÖ Voted':'üëç Vote'}</button>
        <span class="count" id="c_${d.id}">${total}</span>
        <button class="btn ghost" data-reset="${d.id}" title="Reset this card">‚ôªÔ∏è</button>
      </div>`;
    addLongPress(el.querySelector(`[data-vote="${d.id}"]`), ()=>{ delete myVotes[d.id]; saveJson(votesKey,myVotes); render(); });
    grid.appendChild(el);
  });

  // Leaderboard
  const container = $('#leaderboard'); container.innerHTML='';
  const sorted = [...ITINS].sort((a,b)=>groupTotalFor(b.id)-groupTotalFor(a.id));
  sorted.forEach((d,i)=>{
    const row = document.createElement('div');
    row.className='lead-row';
    row.innerHTML = `<div class="lead-name">${i+1}. ${d.name}</div><div class="lead-score">${groupTotalFor(d.id)}</div>`;
    container.appendChild(row);
  });

  $('#groupCount').textContent = `Members seen (incl. you): ${1 + groupMembers.length}`;
  wireCarousels();
}
function groupTotalFor(id){ let sum=myVotes[id]?1:0; for(const m of groupMembers){ if(m[id]) sum+=1; } return sum; }
function topScore(){ return Math.max(0, ...ITINS.map(d=>groupTotalFor(d.id))); }

/* ---------- Events ---------- */
function addLongPress(el, cb){ let t; el.addEventListener('touchstart', ()=>{ t=setTimeout(cb,600) }, {passive:true}); ['touchend','touchcancel','touchmove'].forEach(ev=> el.addEventListener(ev, ()=> clearTimeout(t), {passive:true})); }

document.addEventListener('click', (e)=>{
  const id = e.target?.dataset?.vote;
  if(id){ const wasOn=!!myVotes[id]; if(wasOn) delete myVotes[id]; else myVotes[id]=1; saveJson(votesKey,myVotes); render(); return; }

  const reset = e.target?.dataset?.reset;
  if(reset){ delete myVotes[reset]; saveJson(votesKey,myVotes); render(); return; }

  const prev = e.target?.dataset?.prev;
  const next = e.target?.dataset?.next;
  if(prev || next){
    const cid = prev || next;
    const track = document.getElementById(`trk_${cid}`);
    const dots = Array.from(document.querySelectorAll(`#dots_${cid} .dot`));
    const w = track.clientWidth;
    const idxNow = Math.round(track.scrollLeft / w);
    const idx = prev ? Math.max(0, idxNow-1) : Math.min(dots.length-1, idxNow+1);
    track.scrollTo({left: idx*w, behavior: 'smooth'});
    dots.forEach((d,i)=> d.classList.toggle('active', i===idx));
  }

  if(e.target?.classList?.contains('dot')){
    const cid = e.target.dataset.dot;
    const idx = +e.target.dataset.idx;
    const track = document.getElementById(`trk_${cid}`);
    const w = track.clientWidth;
    track.scrollTo({left: idx*w, behavior:'smooth'});
    const dots = Array.from(document.querySelectorAll(`#dots_${cid} .dot`));
    dots.forEach((d,i)=> d.classList.toggle('active', i===idx));
  }

  const factsId = e.target?.dataset?.facts;
  if(factsId){ openFacts(factsId); }
});

/* Search/share/import only for votes */
const votesKeyUrl = 'votes';
const groupKeyUrl = 'group';

$('#share').addEventListener('click', ()=>{
  const url = `${location.origin}${location.pathname}?${votesKeyUrl}=${encodeURIComponent(JSON.stringify(myVotes))}`;
  navigator.clipboard.writeText(url).then(()=> alert('Copied your votes link! Paste into the group.'));
});
$('#shareGroup').addEventListener('click', ()=>{
  const payload = [myVotes, ...groupMembers];
  const url = `${location.origin}${location.pathname}?${groupKeyUrl}=${encodeURIComponent(JSON.stringify(payload))}`;
  navigator.clipboard.writeText(url).then(()=> alert('Copied Group Totals link!'));
});
$('#importBtn').addEventListener('click', ()=>{
  const link = prompt('Paste a friend‚Äôs ‚ÄúShare My Votes‚Äù link or a Group Totals link.');
  if(!link) return;
  try{
    const u = new URL(link);
    const g = u.searchParams.get(groupKeyUrl); const v = u.searchParams.get(votesKeyUrl);
    if(g){
      const arr = JSON.parse(decodeURIComponent(g));
      const set = new Set(groupMembers.map(m=>JSON.stringify(m)));
      arr.forEach(m=>{ const s=JSON.stringify(m); if(!set.has(s)){ groupMembers.push(m); set.add(s);} });
      saveJson(groupKey, groupMembers); render(); alert('Imported group totals.'); return;
    }
    if(v){
      const obj = JSON.parse(decodeURIComponent(v));
      const already = groupMembers.some(m=>JSON.stringify(m)===JSON.stringify(obj));
      if(!already){ groupMembers.push(obj); saveJson(groupKey, groupMembers); }
      render(); alert('Imported a friend‚Äôs votes.'); return;
    }
    alert('No votes found.');
  }catch{ alert('Bad link.'); }
});
$('#resetVotes').addEventListener('click', ()=>{ if(confirm('Reset ONLY this device‚Äôs votes?')){ myVotes={}; saveJson(votesKey,myVotes); render(); } });
$('#resetGroup').addEventListener('click', ()=>{ if(confirm('Remove all imported friends and keep only this device?')){ groupMembers=[]; saveJson(groupKey, groupMembers); render(); } });

/* Leaderboard & Compare toggles */
const sheet = $('#sheet'); $('#toggleSheet').addEventListener('click', ()=> sheet.classList.toggle('open'));
const cmp = $('#compare'); const cmpGrid = $('#cmpGrid');
$('#toggleCompare').addEventListener('click', openCompare);
$('#cmpClose').addEventListener('click', ()=> cmp.classList.remove('open'));

/* Facts modal handlers */
const factsModal = $('#factsModal');
$('#factsClose').addEventListener('click', ()=> factsModal.classList.remove('open'));
factsModal.querySelector('.veil').addEventListener('click', ()=> factsModal.classList.remove('open'));

/* Facts modal content (shows day-by-day) */
function openFacts(id){
  const d = ITINS.find(x=>x.id===id); if(!d) return;
  document.getElementById('factsTitle').textContent = d.name;
  document.getElementById('factsSub').textContent = `${d.cat} ¬∑ ${d.tags.map(t=>'#'+t).join(' ')}`;
  const body = document.getElementById('factsBody'); body.innerHTML = '';

  const rows = [
    ['Why', d.why],
    ['Best time', d.facts?.bestTime],
    ['Stays', d.facts?.stays],
    ['Vibe', d.facts?.vibe],
    ['Map', d.facts?.map ? `<a class="btn hot" style="padding:6px 10px" target="_blank" rel="noopener" href="${d.facts.map}">Open in Maps</a>` : '']
  ];
  rows.forEach(([b,t])=>{ if(!t) return; const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div class="b">${b}</div><div class="t">${t}</div>`; body.appendChild(row); });

  if(d.days?.length){
    const row=document.createElement('div'); row.className='row';
    row.innerHTML = `<div class="b">Itinerary</div><div class="t">${d.days.map(([k,v])=>`<div><b>${k}:</b> ${v}</div>`).join('')}</div>`;
    body.appendChild(row);
  }
  factsModal.classList.add('open');
}

/* Compare the two cards */
function openCompare(){
  const top = [...ITINS].sort((a,b)=> groupTotalFor(b.id)-groupTotalFor(a.id)).slice(0,2);
  cmpGrid.innerHTML='';
  top.forEach(d=>{
    const img = d.imgs?.[0] || srcUnsplash(d.name);
    const el = document.createElement('div'); el.className='cmpCard';
    el.innerHTML = `
      <div class="cmpImg"><img src="${img}" alt="${d.name}"></div>
      <div class="cmpBody">
        <h4>${d.name}</h4>
        <div class="mini">${d.cat} ¬∑ ${d.tags.map(t=>'#'+t).join(' ')}</div>
        <p><b>Why:</b> ${d.why}</p>
        <p><b>Highlights:</b> ${d.days.slice(0,3).map(dy=>dy[1]).join(' ¬∑ ')}</p>
      </div>`;
    cmpGrid.appendChild(el);
  });
  cmp.classList.add('open');
}

/* Carousels */
function wireCarousels(){
  ITINS.forEach(d=>{
    const track = document.getElementById(`trk_${d.id}`); if(!track) return;
    track.addEventListener('scroll', ()=>{
      const w=track.clientWidth; const idx=Math.round(track.scrollLeft/w);
      const dots=Array.from(document.querySelectorAll(`#dots_${d.id} .dot`));
      dots.forEach((dot,i)=> dot.classList.toggle('active', i===idx));
    }, {passive:true});
  });
}

/* One-time: import from URL (?votes= / ?group=) */
(function initImportFromURL(){
  const qs = new URLSearchParams(location.search);
  try{
    if(qs.get('group')){
      const arr = JSON.parse(decodeURIComponent(qs.get('group')));
      const set = new Set(groupMembers.map(m=>JSON.stringify(m)));
      arr.forEach(m=>{ const s=JSON.stringify(m); if(!set.has(s)){ groupMembers.push(m); set.add(s);} });
      saveJson(groupKey, groupMembers);
      history.replaceState({}, '', location.pathname);
    } else if(qs.get('votes')){
      const obj = JSON.parse(decodeURIComponent(qs.get('votes')));
      const same = groupMembers.some(m => JSON.stringify(m)===JSON.stringify(obj));
      if(!same){ groupMembers.push(obj); saveJson(groupKey, groupMembers); }
      history.replaceState({}, '', location.pathname);
    }
  }catch{}
})();
render();
</script>
</body>
</html>
